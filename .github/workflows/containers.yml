name: Docker Image CI

on:
  push:
    branches: [ "main"]
    paths-ignore:
      - 'README.md'
  pull_request:
    branches: [ "main" ]

jobs:

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4
    -
        name: Login to OCIR
        uses: docker/login-action@v3
        with:
          registry: fra.ocir.io
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.AUTH_TOKEN }}
    - name: Build and Push the image to OCIR
      run: |
        docker build . --build-arg APIGW_PATH=/api -t fra.ocir.io/${{ secrets.TENANCY_NAMESPACE }}/cars-api-pg:1.0.0
        docker push -q fra.ocir.io/${{ secrets.TENANCY_NAMESPACE }}/cars-api-pg:1.0.0
    - name: Update Stack Manager with webhook
      run: |
        curl -X PUT -H "Authorization: Basic ${{ secrets.STACK_MGR_AUTH }}" "${{ secrets.STACK_MGR_URL }}/webhook/restart?ciname=cars-api-pg&compartmentname=mika.rinne"

        